---
title: "1st-pass analysis of Novartis DECAMP2 Nasal Brushings RNA-seq data"
date: "`r format(Sys.time(), '%d %B, %Y')`"

output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    fig_width: 9
    fig_height: 6
    theme: cosmo
geometry: margin=1in
---

# Preprocessing

Based off of prior QC ("20201025_DECAMP2_Novartis_QC_Nasal.Rmd"), we have identified several poor quality samples. We will remove these samples prior to any downstream analysis.

```{r, message = FALSE, warning=FALSE}
# Load library:
library(plyr)
library(SummarizedExperiment)
library(readxl)
library(dplyr)
library(ggplot2)
library(pheatmap)
library("RColorBrewer")
library(DESeq2)
library(knitr)
library(kableExtra)
library(enrichR)
library(biomaRt)

set.seed("12345")

# Load data:
se <- readRDS("/restricted/projectnb/pulmseq/Novartis/processing/work/28/da9dcb4ebb5f902c53fff1bc1ebdc2/Novartis_Gene_Expression.rds")
colnames(se) <- gsub(pattern = "_.*", "", colnames(se))

# Load annotation:

# Matches sample ID to kitnumber + Has batch info
annotManifest <- read_excel("/restricted/projectnb/pulmseq/Novartis/annotation/Novartis_RNASeq_run_manifest.xlsx")

# Matches sample ID to sample type/RIN (received from Jack, 8/24/20)
annotSampleEM0 <- read_excel("/restricted/projectnb/camplab/home/ykoga07/DECAMP/Novartis/Data/Annotation/RNA_data_for_Yusuke_08_24_20.xlsx", sheet = "EM0", skip = 2)

annotSampleEM5 <- read_excel("/restricted/projectnb/camplab/home/ykoga07/DECAMP/Novartis/Data/Annotation/RNA_data_for_Yusuke_08_24_20.xlsx", sheet = "EM5", skip = 2)

annotSampleEM6 <- read_excel("/restricted/projectnb/camplab/home/ykoga07/DECAMP/Novartis/Data/Annotation/RNA_data_for_Yusuke_08_24_20.xlsx", sheet = "EM6", skip = 2)

annotSampleEM8 <- read_excel("/restricted/projectnb/camplab/home/ykoga07/DECAMP/Novartis/Data/Annotation/RNA_data_for_Yusuke_08_24_20.xlsx", sheet = "EM8", skip = 3)

annotSampleEM15 <- read_excel("/restricted/projectnb/camplab/home/ykoga07/DECAMP/Novartis/Data/Annotation/RNA_data_for_Yusuke_08_24_20.xlsx", sheet = "EM15", skip = 3)

annotSampleEM16 <- read_excel("/restricted/projectnb/camplab/home/ykoga07/DECAMP/Novartis/Data/Annotation/RNA_data_for_Yusuke_08_24_20.xlsx", sheet = "EM16", skip = 3)

annotSampleN1 <- read_excel("/restricted/projectnb/camplab/home/ykoga07/DECAMP/Novartis/Data/Annotation/RNA_data_for_Yusuke_08_24_20.xlsx", sheet = "N1", skip = 3)

annotSampleN2 <- read_excel("/restricted/projectnb/camplab/home/ykoga07/DECAMP/Novartis/Data/Annotation/RNA_data_for_Yusuke_08_24_20.xlsx", sheet = "N2", skip = 3)

# Combine Jack's sample-based annotation file into one dataframe
annotSampleEM0 <- annotSampleEM0[, c(
  "RNA Sample ID", "DECAMP #",
  "Sample ID", "Kit Number", "Original Sample Type",
  "Isolation Date", "RIN", "DV200 (%)"
)]
colnames(annotSampleEM0) <- c(
  "RNA Sample ID", "DECAMP #",
  "Sample ID", "Kit Number", "Sample Type",
  "Isolation Date", "RIN", "DV200 (%)"
)

annotSampleEM5 <- annotSampleEM5[, c(
  "RNA Sample ID", "DECAMP #",
  "Patient ID", "Patient ID", "Sample Type",
  "Isolation Date", "RIN", "DV200 (%)"
)]
colnames(annotSampleEM5) <- c(
  "RNA Sample ID", "DECAMP #",
  "Sample ID", "Kit Number", "Sample Type",
  "Isolation Date", "RIN", "DV200 (%)"
)

annotSampleEM6 <- annotSampleEM6[, c(
  "RNA Sample ID", "DECAMP #",
  "Sample ID", "Kit Number", "Sample Type",
  "Isolation Date", "RIN", "DV200 (%)"
)]
colnames(annotSampleEM6) <- c(
  "RNA Sample ID", "DECAMP #",
  "Sample ID", "Kit Number", "Sample Type",
  "Isolation Date", "RIN", "DV200 (%)"
)

annotSampleEM8 <- annotSampleEM8[, c(
  "RNA Sample ID", "DECAMP #",
  "Sample ID", "Original Sample ID", "Sample Type",
  "Isolation Date", "RIN", "DV200 (%)"
)]
colnames(annotSampleEM8) <- c(
  "RNA Sample ID", "DECAMP #",
  "Sample ID", "Kit Number", "Sample Type",
  "Isolation Date", "RIN", "DV200 (%)"
)

annotSampleEM15 <- annotSampleEM15[, c(
  "RNA Sample ID", "DECAMP #",
  "Sample ID", "Kit Number", "Sample Type",
  "Isolation Date", "RIN", "DV200 (%)"
)]
colnames(annotSampleEM15) <- c(
  "RNA Sample ID", "DECAMP #",
  "Sample ID", "Kit Number", "Sample Type",
  "Isolation Date", "RIN", "DV200 (%)"
)

annotSampleEM16 <- annotSampleEM16[, c(
  "RNA Sample ID", "DECAMP #",
  "Sample ID", "Kit Number", "Sample Type",
  "Isolation Date", "RIN", "DV200 (%)"
)]
colnames(annotSampleEM16) <- c(
  "RNA Sample ID", "DECAMP #",
  "Sample ID", "Kit Number", "Sample Type",
  "Isolation Date", "RIN", "DV200 (%)"
)

annotSampleN1 <- annotSampleN1[, c(
  "RNA Sample ID", "DECAMP #",
  "Sample ID", "Kit Number", "Sample Type",
  "Isolation Date", "RIN", "DV200 (%)"
)]
colnames(annotSampleN1) <- c(
  "RNA Sample ID", "DECAMP #",
  "Sample ID", "Kit Number", "Sample Type",
  "Isolation Date", "RIN", "DV200 (%)"
)

annotSampleN2 <- annotSampleN2[, c(
  "RNA Sample ID", "DECAMP #",
  "Sample ID", "Kit Number", "Sample Type",
  "Isolation Date", "RIN", "DV200 (%)"
)]
colnames(annotSampleN2) <- c(
  "RNA Sample ID", "DECAMP #",
  "Sample ID", "Kit Number", "Sample Type",
  "Isolation Date", "RIN", "DV200 (%)"
)

allAnnotSamples <- ls()[grep("annotSample", ls())]
annotSample <- as.data.frame(matrix(ncol = 8))
colnames(annotSample) <- c(
  "RNA Sample ID", "DECAMP #",
  "Sample ID", "Kit Number", "Sample Type",
  "Isolation Date", "RIN", "DV200 (%)"
)
# Combine
for (x in allAnnotSamples) {
  annotSamples <- get(x)
  annotSamples$`Isolation Date` <- as.character(annotSamples$`Isolation Date`)
  annotSample <- rbind(annotSample, annotSamples)
}
annotSample <- annotSample[-which(is.na(annotSample$`RNA Sample ID`)), ]
annotSample <- annotSample[-which(is.na(annotSample$`Sample Type`)), ]

annotSample <- annotSample[-which(duplicated(annotSample$`RNA Sample ID`)), ]

# Save which samples had wrong rRNA peak when checking RIN
wrongRRNA.ix <- grep(pattern = "rong rRNA peak", annotSample$RIN)
annotSample$wrongRNAPeak <- 0
annotSample$wrongRNAPeak[wrongRRNA.ix] <- 1

# Edit RIN section to convert into numeric vector
annotSample$RIN <- gsub(pattern = "(wrong rRNA peak)", replacement = "", annotSample$RIN, fixed = TRUE)
annotSample$RIN <- gsub(pattern = "(wrong RNA peak)", replacement = "", annotSample$RIN, fixed = TRUE)
annotSample$RIN <- gsub(pattern = "(wrong rRNA peaks)", replacement = "", annotSample$RIN, fixed = TRUE)
annotSample$RIN <- gsub(pattern = "(Wrong rRNA peak)", replacement = "", annotSample$RIN, fixed = TRUE)
annotSample$RIN <- gsub(pattern = "(Wrong rRNA peaks)", replacement = "", annotSample$RIN, fixed = TRUE)
annotSample$RIN <- gsub(pattern = "\\/NA", replacement = "", annotSample$RIN)
annotSample$RIN <- gsub(pattern = ".*\\/", replacement = "", annotSample$RIN)
annotSample$RIN <- as.numeric(annotSample$RIN)
# There is a "29", probably 2.9, will ask Jack
annotSample$RIN[annotSample$RIN == 29] <- 2.9

# Consolidate nasal/bronch terms
annotSample$`Sample Type` <- gsub(pattern = ".*Bronch.*", replacement = "Bronchial Brushings", annotSample$`Sample Type`)
annotSample$`Sample Type` <- gsub(pattern = ".*Nasal.*", replacement = "Nasal Brushings", annotSample$`Sample Type`)

annotManifest <- filter(annotManifest, Run == "Run 1")
annotSample <- annotSample[annotSample$`RNA Sample ID` %in% annotManifest$Sample, ]
annotSample <- annotSample[match(annotSample$`RNA Sample ID`, annotManifest$Sample), ]

# Removing duplicate column
annotManifest$`Kit Number` <- NULL

annot <- cbind(annotManifest, annotSample)

# Clinical info:

# Matches kitnumber to randID, "Novartis_datadump"
annotDataDump2 <- read_excel("/rprojectnb/decamp/annotation/20200920/FullDECAMP2_DataDump_20200920.xlsx", sheet = "_D2CASEMAP", )

# randID to demographics info, "Novartis_datadump"
annotDataDump3 <- read_excel("/rprojectnb/decamp/annotation/20200920/FullDECAMP2_DataDump_20200920.xlsx", sheet = "_D2DEMO")

# randID to age/smoking info, "Novartis_datadump"
annotDataDump4 <- read_excel("/rprojectnb/decamp/annotation/20200920/FullDECAMP2_DataDump_20200920.xlsx", sheet = "_D2ELIGCHECK")

# randID to FEV/FVC, "Novartis_datadump"
annotDataDump5 <- read_excel("/rprojectnb/decamp/annotation/20200920/FullDECAMP2_DataDump_20200920.xlsx", sheet = "_D2PFT")
annotDataDump5 <- filter(annotDataDump5, timepoint == "Baseline Visit")

# Combine annotation info
annotA <- merge(merge(annotDataDump2, annotDataDump3, by.x = "randID", by.y = "randID"), annotDataDump4, by.x = "randID", by.y = "randID")
annotA <- merge(annotA, annotDataDump5, by.x = "randID", by.y = "randID")

# Removing patient "4796-053" as "Pacific Islander" for time being
annotA <- annotA[!(duplicated(annotA$randID)), ]

annot <- merge(annot, annotA, by.x = "Kit Number", by.y = "kitnumber", all.x = TRUE)

annotBronch <- annot[annot$`Sample Type` == "Bronchial Brushings", ]
annotNasal <- annot[annot$`Sample Type` == "Nasal Brushings", ]

uniquePatients <- length(unique(annot$`Kit Number`))

numBronch <- length(unique(annotBronch$Sample))
numNasal <- length(unique(annotNasal$Sample))

bothBronchNasal <- length(intersect(annotBronch$`Kit Number`, annotNasal$`Kit Number`))

#Steiling signature genes
steilingGenes <- read_excel("/restricted/projectnb/camplab/home/ykoga07/DECAMP/Novartis/Analysis/1stPass/Steiling_2013_Genelist.xlsx", sheet = "GeneList", col_names = FALSE)
```
There are `r length(annot$Sample)` samples and `r uniquePatients` unique patients in the dataset. `r numNasal` are nasal samples. There are `r bothBronchNasal` patients that have both bronchial and nasal samples.


```{r, warning = F, message = F}
# Samples flagged by Novartis as poor quality:
# flaggedByNovartis <- c(
#   "EM15-14", "EM15-31", "EM15-64", "EM15-85", "EM16-194", "EM16-195",
#   "EM16-228", "EM5-100", "EM8-112", "EM8-130", "EM8-158", "EM8-171",
#   "EM8-26", "EM8-55", "EM8-66", "N1-115", "N1-119", "N1-125",
#   "N1-139", "N1-25", "N1-40", "N1-55", "N1-63", "N1-64",
#   "N1-67", "N1-81", "N1-83", "N1-84", "N1-94", "N2-10",
#   "N2-15", "N2-18", "N2-30", "N2-31", "N2-22", "N2-28"
# )

poorQuality <- read.table("/restricted/projectnb/camplab/home/ykoga07/DECAMP/Novartis/Analysis/QC/20201026_PoorQuality_Nasal.txt")

seNasal <- se[, which(colnames(se) %in% annotNasal$`RNA Sample ID`)]
orig.num.samples <- ncol(seNasal) 

#Remove:
seNasal <- seNasal[,!colnames(seNasal) %in% poorQuality$V1]
filt.num.samples <- ncol(seNasal) 

annotNasal <- annotNasal[annotNasal$`RNA Sample ID` %in% colnames(se), ]

# reorder
annotNasal <- annotNasal[match(colnames(seNasal), annotNasal$`RNA Sample ID`), ]

coldataNasal <- colData(seNasal)

annotNasal$TIN <- colData(seNasal)$RSeQC_TIN_mean
```

Originally, there were `r orig.num.samples` samples. Upon filtering, we will use `r filt.num.samples` samples for downstream analysis.

```{r, message = F, warning = F}
counts <- assay(seNasal)
rownames(counts) <- rowRanges(seNasal)$external_gene_id

counts <- apply(counts, 1:2, function(x) {
  return(as.integer(x))
})

# copd.status <- sapply(annotNasal$FEV_RS_PER, function(x) {
#   if (x < 80) {
#     return("COPD")
#   } else {
#     return("NO_COPD")
#   }
# })

copd.status <- c()
for(x in 1:nrow(annotNasal)){
  if(annotNasal[x, "FEV_RS_PER"] < 80 && 
     annotNasal[x, "FEV_FVC"] < 0.7){
        copd.status <- c(copd.status, "COPD")
  }else{
       copd.status <- c(copd.status, "NO_COPD")
     }
}
annotNasal$COPD_status <- as.factor(copd.status)
annotNasal$GRPB_SMK_STS <- gsub(" ", "_", annotNasal$GRPB_SMK_STS)

no.smk.status.ix <- which(is.na(annotNasal$GRPB_SMK_STS))

# counts <- counts[, -no.smk.status.ix]
# annotNasal <- annotNasal[-no.smk.status.ix, ]
```

`r length(no.smk.status.ix)` samples were removed due to lack of smoker status.

```{r}
remove.ix <- which(colnames(counts) == "N2-28")

counts <- counts[, -remove.ix]
annotNasal <- annotNasal[-remove.ix, ]
coldataNasal <- coldataNasal[-remove.ix,]

remove.ix <- which(annotNasal$TIN < 60)
counts <- counts[, -remove.ix]
annotNasal <- annotNasal[-remove.ix, ]
coldataNasal <- coldataNasal[-remove.ix,]
```

Sample "N2-28" was removed due to abnormally low counts (n = 541048, Average: 18542574). In total, there are now `r ncol(counts)` samples used for downstream analysis.

# Clinical annotation

General annotation data of patients were compared between those of which samples of FEV1 predicted < 80 (COPD) and FEV1 predicted > 80 (NO COPD).

```{r, warning = FALSE, message = FALSE}
#Rename race
annotNasal$RACE_CAT_TXT <- gsub("Unknown","Not Reported",annotNasal$RACE_CAT_TXT)
annotNasal$RACE_CAT_TXT <- gsub("Black or Afr. American",
                                 "Black/African American",annotNasal$RACE_CAT_TXT)
annotNasal$RACE_CAT_TXT <- gsub("Native Hawaiian or Other Pacific Islander",
                                 "Pacific Islander",annotNasal$RACE_CAT_TXT)
annotNasal$RACE_CAT_TXT <- gsub("American Indian or Alaska Native",
                                 "Native American",annotNasal$RACE_CAT_TXT)
annotNasal$RACE_CAT_TXT <- as.factor(annotNasal$RACE_CAT_TXT)

annotNasal_COPD <- annotNasal[annotNasal$COPD_status == "COPD", ]

annotNasal_NO_COPD <- annotNasal[annotNasal$COPD_status == "NO_COPD", ]

lab <- c(
  rep("Retained", length(annotNasal_COPD$GRPB_SMK_STS)),
  rep("Removed", length(annotNasal_NO_COPD$GRPB_SMK_STS))
)
# AGE
mean.age <- mean(annotNasal_COPD$AGE)
sd.age <- sd(annotNasal_COPD$AGE)

age <- paste0(signif(mean.age, 3), " +/- ", signif(sd.age, 3))

mean.age.rm <- mean(annotNasal_NO_COPD$AGE)
sd.age.rm <- sd(annotNasal_NO_COPD$AGE)

age.rm <- paste0(signif(mean.age.rm, 3), " +/- ", signif(sd.age.rm, 3))

age.pvalue <- signif(wilcox.test(annotNasal_COPD$AGE, annotNasal_NO_COPD$AGE)$p.value, 3)

demo.table <- c(age, age.rm, age.pvalue)

# Gender
gstatus <- c(annotNasal_COPD$PERSON_GENDER, annotNasal_NO_COPD$PERSON_GENDER)

male.ct <- sum(annotNasal_COPD$PERSON_GENDER == "Male Gender")
male.pct <- signif(male.ct / length(annotNasal_COPD$PERSON_GENDER), 3) * 100
male <- paste0("Male: ", male.ct, "(", male.pct, "%)")

male.ct.rm <- sum(annotNasal_NO_COPD$PERSON_GENDER == "Male Gender")
male.pct.rm <- signif(male.ct.rm / length(annotNasal_NO_COPD$PERSON_GENDER), 3) * 100
male.rm <- paste0("Male: ", male.ct.rm, "(", male.pct.rm, "%)")

gender.pvalue <- signif(chisq.test(table(lab, gstatus))$p.value, 3)

demo.table <- rbind(demo.table, c(male, male.rm, gender.pvalue))

# FEV1 predicted
mean.fev1p <- mean(annotNasal_COPD$FEV_RS_PER)
sd.fev1p <- sd(annotNasal_COPD$FEV_RS_PER)

fev1p <- paste0(signif(mean.fev1p, 3), " +/- ", signif(sd.fev1p, 3))

mean.fev1p.rm <- mean(annotNasal_NO_COPD$FEV_RS_PER)
sd.fev1p.rm <- sd(annotNasal_NO_COPD$FEV_RS_PER)

fev1p.rm <- paste0(signif(mean.fev1p.rm, 3), " +/- ", signif(sd.fev1p.rm, 3))

fev1p.pvalue <- signif(wilcox.test(annotNasal_COPD$FEV_RS_PER, annotNasal_NO_COPD$FEV_RS_PER)$p.value, 3)

demo.table <- rbind(demo.table, c(fev1p, fev1p.rm, fev1p.pvalue))


# FEVFVC
mean.fevfvc <- mean(annotNasal_COPD$FEV_FVC)
sd.fevfvc <- sd(annotNasal_COPD$FEV_FVC)

fevfvc <- paste0(signif(mean.fevfvc, 3), " +/- ", signif(sd.fevfvc, 3))

mean.fevfvc.rm <- mean(annotNasal_NO_COPD$FEV_FVC)
sd.fevfvc.rm <- sd(annotNasal_NO_COPD$FEV_FVC)

fevfvc.rm <- paste0(signif(mean.fevfvc.rm, 3), " +/- ", signif(sd.fevfvc.rm, 3))

fevfvc.pvalue <- signif(wilcox.test(annotNasal_COPD$FEV_FVC, annotNasal_NO_COPD$FEV_FVC)$p.value, 3)

demo.table <- rbind(demo.table, c(fevfvc, fevfvc.rm, fevfvc.pvalue))

# TIN
mean.tin <- mean(annotNasal_COPD$TIN)
sd.tin <- sd(annotNasal_COPD$TIN)

tin <- paste0(signif(mean.tin, 3), " +/- ", signif(sd.tin, 3))

mean.tin.rm <- mean(annotNasal_NO_COPD$TIN)
sd.tin.rm <- sd(annotNasal_NO_COPD$TIN)

tin.rm <- paste0(signif(mean.tin.rm, 3), " +/- ", signif(sd.tin.rm, 3))

tin.pvalue <- signif(wilcox.test(annotNasal_COPD$TIN, annotNasal_NO_COPD$TIN)$p.value, 3)

demo.table <- rbind(demo.table, c(tin, tin.rm, tin.pvalue))

# Smoking Status
smk <- c(annotNasal_COPD$GRPB_SMK_STS, annotNasal_NO_COPD$GRPB_SMK_STS)

annotNasal_COPD$GRPB_SMK_STS <- gsub(" ", "_", annotNasal_COPD$GRPB_SMK_STS)
annotNasal_NO_COPD$GRPB_SMK_STS <- gsub(" ", "_", annotNasal_NO_COPD$GRPB_SMK_STS)

smkstatus.na <- sum(is.na(annotNasal_COPD$GRPB_SMK_STS == "Current_Smoker"))

smkstatus.ct <- sum(annotNasal_COPD[!is.na(annotNasal_COPD$GRPB_SMK_STS), ]$GRPB_SMK_STS == "Current_Smoker")
smkstatus.pct <- signif(smkstatus.ct / nrow(annotNasal_COPD[!is.na(annotNasal_COPD$GRPB_SMK_STS), ]), 3) * 100
smkstatus <- paste0("Current: ", smkstatus.ct, "(", smkstatus.pct, "%)")

smkstatus.ct.rm <- sum(annotNasal_NO_COPD$GRPB_SMK_STS == "Current_Smoker")
smkstatus.pct.rm <- signif(smkstatus.ct.rm / length(annotNasal_NO_COPD$GRPB_SMK_STS), 3) * 100
smkstatus.rm <- paste0("Current: ", smkstatus.ct.rm, "(", smkstatus.pct.rm, "%)")

smkstatus.pvalue <- signif(chisq.test(table(lab, smk))$p.value, 3)

demo.table <- rbind(demo.table, c(smkstatus, smkstatus.rm, smkstatus.pvalue))

rownames(demo.table) <- c("Age", "Gender", "FEV1 Predicted (%)" , "FEV1/FVC", "TIN","Smoking Status")
colnames(demo.table) <- c("COPD", "NO COPD", "p-value")

copd.race.table <- as.data.frame(table(annotNasal_COPD$RACE_CAT_TXT))
rownames(copd.race.table) <- copd.race.table$Var1
copd.race.table$Var1 <- NULL

nocopd.race.table <- as.data.frame(table(annotNasal_NO_COPD$RACE_CAT_TXT))
rownames(nocopd.race.table) <- nocopd.race.table$Var1
nocopd.race.table$Var1 <- NULL

race.table <- cbind(copd.race.table, nocopd.race.table)
race.table <- race.table[c(5, 1, 2, 4, 3),]
colnames(race.table) <- c("COPD", "NO COPD")
race.table$`p-value` <- c(signif(chisq.test(race.table)$p.value, 3),
                        rep("", nrow(race.table) - 1))

blank <- as.data.frame(matrix("", ncol = 3))
colnames(blank) <- c("COPD", "NO COPD", "p-value")
rownames(blank) <- "Race"

race.table <- rbind(blank,race.table)

demo.table <- rbind(demo.table, race.table)

demo.table %>%
  knitr::kable(
    format = "html", align = rep("c", ncol(demo.table) + 1),
    row.names = TRUE
  ) %>%
  add_indent(c(7:12)) %>%
  kableExtra::kable_styling()
```

# Differential Expression 

## Using COPD as continuous variable

Differential expression was conducted using the DESeq2 package to compare patients with low FEV1pred values (< 80) and high values. The FEV1 predicted values are used as a proxy for COPD status. Expected counts outputted from the RSEM algorithm was taken for DESeq2. 

### Model used: ~Smoking status + Age + FEV1 predicted {.tabset}

```{r, message = F, warning = F}
dds <- DESeqDataSetFromMatrix(
  countData = counts,
  colData = annotNasal,
  design = ~GRPB_SMK_STS + AGE + TIN + FEV_RS_PER
)

dds$GRPB_SMK_STS <- relevel(dds$GRPB_SMK_STS, ref = "Former_Smoker")

keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep, ]
dds <- DESeq(dds)
res <- results(dds)

res$nLogPVal <- -log10(res$padj)

resOrdered <- res[order(res$pvalue), ]
resOrdered <- as.data.frame(resOrdered)

#For pre-ranked GSEA
resOrderLFC <- res[order(res$log2FoldChange), ]
resOrderLFC <- resOrderLFC[,2, drop = F]
resOrderLFC$Gene <- rownames(resOrderLFC)
resOrderLFC <- resOrderLFC[,c(2,1)]
#write.table(resOrderLFC, "20201104_GSEA_Rankedlist_FEVPred_Bronch.rnk", sep = "\t", col.names = T, row.names = F)

resSig <- resOrdered[resOrdered$padj < 0.05,]
resSig <- resSig[!is.na(resSig$padj),]

resSig <- resSig[order(resSig$log2FoldChange), ]
numSig <- nrow(resSig)

resSigUp <- resSig[head(order(resSig$log2FoldChange, decreasing = T), 50),]
resSigDown <- resSig[head(order(resSig$log2FoldChange, decreasing = F), 50),]
resSig2 <- rbind(resSigDown, resSigUp)
numUp <- nrow(resSig[resSig$log2FoldChange > 0.5, ])
numDown <- nrow(resSig[resSig$log2FoldChange < -0.5, ])

resSig3 <- resSig[abs(resSig$log2FoldChange) > 0.01,]
```

A total of `r numSig` genes passed the FDR < 0.05 threshold. 

#### Volcano plot

```{r, message = F, warning = F}
ggplot(resOrdered, aes(x = log2FoldChange, y = nLogPVal)) +
  geom_point(size = 0.75) +
  ggplot2::theme_bw() +
  ggplot2::theme(
    panel.grid.major = ggplot2::element_blank(),
    panel.grid.minor = ggplot2::element_blank(),
    axis.text = ggplot2::element_text(size = 14),
    axis.title = ggplot2::element_text(size = 14)
  ) +
  ggplot2::theme(legend.title = ggplot2::element_text(size = 15), legend.text = ggplot2::element_text(size = 13)) +
  ggplot2::guides(
    colour =
      ggplot2::guide_legend(override.aes = list(size = 2))
  ) +
  geom_point(data = resSig, aes(x = log2FoldChange, y = nLogPVal), color = "Red")+
  ggplot2::labs(y = "-log10(Adjusted p-value)") +
  ggplot2::ggtitle(label = "COPD status") +
  ggplot2::theme(plot.title = ggplot2::element_text(
    hjust = 0.5,
    size = 18
  ))
```

#### Heatmap

```{r}
counts.z <- t(scale(t(counts)))
counts.z.trim <- counts.z

counts.z.trim[counts.z.trim < -2] <- -2
counts.z.trim[counts.z.trim > 2] <- 2

counts.z.trim <- counts.z.trim[rownames(counts.z.trim) %in% rownames(resSig3),]

COPD_status <- annotNasal$COPD_status
Smoker_status <- annotNasal$GRPB_SMK_STS

annotation_col <- data.frame(COPD_status, Smoker_status)
rownames(annotation_col) <- colnames(counts.z.trim)
callback <- function(hc, mat) {
  sv <- svd(t(mat))$v[, 1]
  dend <- reorder(as.dendrogram(hc), wts = sv)
  as.hclust(dend)
}

out <- pheatmap(counts.z.trim,
  color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(100),
  annotation_col = annotation_col,
  legend = T,
  show_rownames = F,
  show_colnames = F,
  fontsize_row = 9,
  cluster_rows = TRUE,
  cluster_cols = TRUE
)

out
```

#### Tables

##### Top 20 most upregulated in higher FEV1 predicted

```{r}
# resSigUp <- res[head(order(res$log2FoldChange, decreasing = T), 20),]
resSigUp <- resSigUp[,c(2,5,6)]
colnames(resSigUp) <- c("Log2FC", "P-value", "Adj. P-value")
resSigUp %>%
  knitr::kable(
    format = "html", align = rep("c", ncol(resSig) + 1),
    row.names = TRUE
  ) %>%
  kableExtra::kable_styling() %>%
  kableExtra::scroll_box(height = "300px")
```

\n

##### Top 20 most downregulated in higher FEV1 predicted

```{r}
# resSigDown <- res[head(order(res$log2FoldChange, decreasing = F), 20),]
resSigDown <- resSigDown[,c(2,5,6)]
colnames(resSigDown) <- c("Log2FC", "P-value", "Adj. P-value")
resSigDown %>%
  knitr::kable(
    format = "html", align = rep("c", ncol(resSig) + 1),
    row.names = TRUE
  ) %>%
  kableExtra::kable_styling() %>%
  kableExtra::scroll_box(height = "300px")
```

<br>
</br>


### Model used: ~Smoking status + Age + TIN + FEV1 predicted {.tabset}

```{r, message = F, warning = F}
dds <- DESeqDataSetFromMatrix(
  countData = counts,
  colData = annotNasal,
  design = ~GRPB_SMK_STS + AGE + TIN + FEV_RS_PER
)

dds$GRPB_SMK_STS <- relevel(dds$GRPB_SMK_STS, ref = "Former_Smoker")

keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep, ]
dds <- DESeq(dds)
res <- results(dds)

res$nLogPVal <- -log10(res$padj)

resOrdered <- res[order(res$pvalue), ]
resOrdered <- as.data.frame(resOrdered)

#For pre-ranked GSEA
resOrderLFC <- res[order(res$log2FoldChange), ]
resOrderLFC <- resOrderLFC[,2, drop = F]
resOrderLFC$Gene <- rownames(resOrderLFC)
resOrderLFC <- resOrderLFC[,c(2,1)]
#write.table(resOrderLFC, "20201104_GSEA_Rankedlist_FEVPred_Bronch.rnk", sep = "\t", col.names = T, row.names = F)

resSig <- resOrdered[resOrdered$padj < 0.05,]
resSig <- resSig[!is.na(resSig$padj),]

resSig <- resSig[order(resSig$log2FoldChange), ]
numSig <- nrow(resSig)

resSigUp <- resSig[head(order(resSig$log2FoldChange, decreasing = T), 50),]
resSigDown <- resSig[head(order(resSig$log2FoldChange, decreasing = F), 50),]
resSig2 <- rbind(resSigDown, resSigUp)
# numUp <- nrow(resSig[resSig$log2FoldChange > 0.5, ])
# numDown <- nrow(resSig[resSig$log2FoldChange < -0.5, ])

resSig3 <- resSig[abs(resSig$log2FoldChange) > 0.01,]
```

A total of `r nrow(resSig)` genes were passed the adjusted p-value < 0.05 threshold.

#### Volcano plot

```{r, message = F, warning = F}
ggplot(resOrdered, aes(x = log2FoldChange, y = nLogPVal)) +
  geom_point(size = 0.75) +
  ggplot2::theme_bw() +
  ggplot2::theme(
    panel.grid.major = ggplot2::element_blank(),
    panel.grid.minor = ggplot2::element_blank(),
    axis.text = ggplot2::element_text(size = 14),
    axis.title = ggplot2::element_text(size = 14)
  ) +
  ggplot2::theme(legend.title = ggplot2::element_text(size = 15), legend.text = ggplot2::element_text(size = 13)) +
  ggplot2::guides(
    colour =
      ggplot2::guide_legend(override.aes = list(size = 2))
  ) +
  geom_point(data = resSig, aes(x = log2FoldChange, y = nLogPVal), color = "Red")+
  ggplot2::labs(y = "-log10(Adjusted p-value)") +
  ggplot2::ggtitle(label = "COPD status") +
  ggplot2::theme(plot.title = ggplot2::element_text(
    hjust = 0.5,
    size = 18
  ))
```

### Tables

#### Top 20 most upregulated in higher FEV1 predicted

```{r}
# resSigUp <- res[head(order(res$log2FoldChange, decreasing = T), 20),]
resSigUp <- resSigUp[,c(2,5,6)]
colnames(resSigUp) <- c("Log2FC", "P-value", "Adj. P-value")
resSigUp %>%
  knitr::kable(
    format = "html", align = rep("c", ncol(resSig) + 1),
    row.names = TRUE
  ) %>%
  kableExtra::kable_styling() %>%
  kableExtra::scroll_box(height = "300px")
```

\n

#### Top 20 most downregulated in higher FEV1 predicted

```{r}
# resSigDown <- res[head(order(res$log2FoldChange, decreasing = F), 20),]
resSigDown <- resSigDown[,c(2,5,6)]
colnames(resSigDown) <- c("Log2FC", "P-value", "Adj. P-value")
resSigDown %>%
  knitr::kable(
    format = "html", align = rep("c", ncol(resSig) + 1),
    row.names = TRUE
  ) %>%
  kableExtra::kable_styling() %>%
  kableExtra::scroll_box(height = "300px")
```

\n

#### Top 20 most upregulated in higher TIN

```{r}
res <- results(dds, name = "TIN")
resOrdered <- res[order(res$pvalue), ]
resOrdered <- as.data.frame(resOrdered)

resSig <- resOrdered[resOrdered$padj < 0.05,]
resSig <- resSig[!is.na(resSig$padj),]

resSig <- resSig[order(resSig$log2FoldChange), ]
numSig <- nrow(resSig)

resSigUp <- resSig[head(order(resSig$log2FoldChange, decreasing = T), 50),]
resSigDown <- resSig[head(order(resSig$log2FoldChange, decreasing = F), 50),]

resSigUp <- resSigUp[,c(2,5,6)]
colnames(resSigUp) <- c("Log2FC", "P-value", "Adj. P-value")
resSigUp %>%
  knitr::kable(
    format = "html", align = rep("c", ncol(resSig) + 1),
    row.names = TRUE
  ) %>%
  kableExtra::kable_styling() %>%
  kableExtra::scroll_box(height = "300px")
```

\n

#### Top 20 most downregulated in higher TIN

```{r}
# resSigDown <- res[head(order(res$log2FoldChange, decreasing = F), 20),]
resSigDown <- resSigDown[,c(2,5,6)]
colnames(resSigDown) <- c("Log2FC", "P-value", "Adj. P-value")
resSigDown %>%
  knitr::kable(
    format = "html", align = rep("c", ncol(resSig) + 1),
    row.names = TRUE
  ) %>%
  kableExtra::kable_styling() %>%
  kableExtra::scroll_box(height = "300px")
```

<br>
</br>

<br>
</br>

## Using COPD as categorical variable {.tabset}

Differential expression was conducted using the DESeq2 package to compare patients with low FEV1pred values (< 80) and high values, where all samples with low FEV1pred is considered to be COPD. Expected counts outputted from the RSEM algorithm was taken for DESeq2. 

Model used: ~Smoking status + Age + COPD status

```{r, message = F, warning = F}
dds <- DESeqDataSetFromMatrix(
  countData = counts,
  colData = annotNasal,
  design = ~GRPB_SMK_STS + AGE + COPD_status
)

dds$GRPB_SMK_STS <- relevel(dds$GRPB_SMK_STS, ref = "Former_Smoker")

keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep, ]
dds <- DESeq(dds)
res <- results(dds)

res$nLogPVal <- -log10(res$padj)

resOrdered <- res[order(res$pvalue), ]
resOrdered <- as.data.frame(resOrdered)

#For pre-ranked GSEA
resOrderLFC <- res[order(res$log2FoldChange), ]
resOrderLFC <- resOrderLFC[,2, drop = F]
resOrderLFC$Gene <- rownames(resOrderLFC)
resOrderLFC <- resOrderLFC[,c(2,1)]

# write.table(resOrderLFC, "20201111_GSEA_Rankedlist_COPDstatus_Nasal.rnk", sep = "\t", col.names = T, row.names = F)

resOrdered <- resOrdered[abs(resOrdered$log2FoldChange) < 10,]
resSig <- resOrdered %>%
  filter(padj < 0.05) %>%
  filter(abs(log2FoldChange) > 0.5)
numSig <- nrow(resSig)
numUp <- nrow(resSig[resSig$log2FoldChange > 0.5, ])
numDown <- nrow(resSig[resSig$log2FoldChange < -0.5, ])
```

A total of `r numSig`(`r numUp` Upregulated, `r numDown` Downregulated) genes were differentially expressed (padj < 0.05, abs(log2FC) > 0.25).

### Volcano plot

```{r, message = F, warning = F}
ggplot(resOrdered, aes(x = log2FoldChange, y = nLogPVal)) +
  geom_point(size = 0.75) +
  ggplot2::theme_bw() +
  ggplot2::theme(
    panel.grid.major = ggplot2::element_blank(),
    panel.grid.minor = ggplot2::element_blank(),
    axis.text = ggplot2::element_text(size = 14),
    axis.title = ggplot2::element_text(size = 14)
  ) +
  ggplot2::theme(legend.title = ggplot2::element_text(size = 15), legend.text = ggplot2::element_text(size = 13)) +
  ggplot2::guides(
    colour =
      ggplot2::guide_legend(override.aes = list(size = 2))
  ) +
  geom_point(data = resSig, aes(x = log2FoldChange, y = nLogPVal), color = "Red")+
  ggplot2::labs(y = "-log10(Adjusted p-value)") +
  ggplot2::ggtitle(label = "COPD status") +
  ggplot2::theme(plot.title = ggplot2::element_text(
    hjust = 0.5,
    size = 18
  ))
```

### Heatmap

```{r}
counts.z <- t(scale(t(counts)))
counts.z.trim <- counts.z

counts.z.trim[counts.z.trim < -2] <- -2
counts.z.trim[counts.z.trim > 2] <- 2

counts.z.trim <- counts.z.trim[rownames(counts.z.trim) %in% rownames(resSig),]

COPD_status <- annotNasal$COPD_status
Smoker_status <- annotNasal$GRPB_SMK_STS

annotation_col <- data.frame(COPD_status, Smoker_status)
rownames(annotation_col) <- colnames(counts.z.trim)
callback <- function(hc, mat) {
  sv <- svd(t(mat))$v[, 1]
  dend <- reorder(as.dendrogram(hc), wts = sv)
  as.hclust(dend)
}

out <- pheatmap(counts.z.trim,
  color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(100),
  annotation_col = annotation_col,
  legend = T,
  show_rownames = F,
  show_colnames = F,
  fontsize_row = 9,
  cluster_rows = TRUE,
  cluster_cols = TRUE
)

out
```

### Violin Plots

```{r}
dots <- T
boxplot <- F
violin <- T

df <- data.frame(
  x = annotNasal$`Sample Type`,
  y = counts["PRAMEF5",]
)

p <- ggplot2::ggplot(df) +
  ggplot2::aes_string(
    x = "x",
    y = "y"
  )
if (dots == TRUE) {
  p <- p + ggplot2::geom_jitter(
    color = "blue",
    width = 0.2,
    height = 0,
    size = 1,
    alpha = 1
  )
}
if (boxplot == TRUE) {
  p <- p + ggplot2::geom_boxplot(
    width = 0.5,
    alpha = 0
  )
}
if (violin == TRUE) {
  p <- p + ggplot2::geom_violin(
    trim = TRUE,
    scale = "width",
    size = 1,
    fill = "grey",
    alpha = 0.75
  )
}

p <- p + ggplot2::theme_bw() +
  ggplot2::theme(
    panel.grid.major = ggplot2::element_blank(),
    panel.grid.minor = ggplot2::element_blank(),
    axis.text = ggplot2::element_text(size = 14),
    axis.title = ggplot2::element_text(size = 10)
  ) + ggplot2::theme(axis.text.x = ggplot2::element_text(size = 15)) +
  ggplot2::ylab("Counts") +
  ggplot2::theme(
    axis.title.y = element_text(size = 15),
    axis.title.x = ggplot2::element_blank()
  )

p <- p + ggplot2::ggtitle(label = "Gene: PRAMEF5") +
  ggplot2::theme(plot.title = ggplot2::element_text(
    hjust = 0.5,
    size = 18
  ))

p
```

```{r}
dots <- T
boxplot <- T
violin <- T

df <- data.frame(
  x = annotNasal$COPD_status,
  y = annotNasal$TIN
)

p <- ggplot2::ggplot(df) +
  ggplot2::aes_string(
    x = "x",
    y = "y"
  )
if (dots == TRUE) {
  p <- p + ggplot2::geom_jitter(
    color = "blue",
    width = 0.2,
    height = 0,
    size = 1,
    alpha = 1
  )
}
if (boxplot == TRUE) {
  p <- p + ggplot2::geom_boxplot(
    width = 0.5,
    alpha = 0
  )
}
if (violin == TRUE) {
  p <- p + ggplot2::geom_violin(
    trim = TRUE,
    scale = "width",
    size = 1,
    fill = "grey",
    alpha = 0.75
  )
}

p <- p + ggplot2::theme_bw() +
  ggplot2::theme(
    panel.grid.major = ggplot2::element_blank(),
    panel.grid.minor = ggplot2::element_blank(),
    axis.text = ggplot2::element_text(size = 14),
    axis.title = ggplot2::element_text(size = 10)
  ) + ggplot2::theme(axis.text.x = ggplot2::element_text(size = 15)) +
  ggplot2::ylab("TIN") +
  ggplot2::theme(
    axis.title.y = element_text(size = 15),
    axis.title.x = ggplot2::element_blank()
  )

p <- p + ggplot2::ggtitle(label = "COPD status vs TIN") +
  ggplot2::theme(plot.title = ggplot2::element_text(
    hjust = 0.5,
    size = 18
  ))

p
```

```{r, message = F, warning = F}
df <- data.frame(x = annotNasal$FEV_RS_PER, y = annotNasal$TIN)
lm_eqn <- function(df){
  # browser()
  m <- lm(y ~ x, df)
  a <- coef(m)[1]
  a <- ifelse(sign(a) >= 0, 
              paste0(" + ", format(a, digits = 4)), 
              paste0(" - ", format(-a, digits = 4))  )
  eq1 <- substitute( paste( italic(y) == b, italic(x), a ), 
                     list(a = a, 
                          b = format(coef(m)[2], digits = 4)))
  eq2 <- substitute( paste( italic(R)^2 == r2 ), 
                     list(r2 = format(summary(m)$r.squared, digits = 3)))
  c( as.character(as.expression(eq1)), as.character(as.expression(eq2)))
}

labels <- lm_eqn(df)


ggplot(annotNasal, aes(x = FEV_RS_PER, y = TIN)) +
  geom_point(size = 0.75) +
  ggplot2::theme_bw() +
  ggplot2::theme(
    panel.grid.major = ggplot2::element_blank(),
    panel.grid.minor = ggplot2::element_blank(),
    axis.text = ggplot2::element_text(size = 14),
    axis.title = ggplot2::element_text(size = 14)
  ) +
  ggplot2::theme(legend.title = ggplot2::element_text(size = 15), legend.text = ggplot2::element_text(size = 13)) +
  ggplot2::guides(
    colour =
      ggplot2::guide_legend(override.aes = list(size = 2))
  ) + geom_smooth(method=lm)+
  geom_text(x = 75, y = 90, label = labels[1], parse = TRUE,  check_overlap = TRUE )

# 
#   geom_point(data = resSig, aes(x = log2FoldChange, y = nLogPVal), color = "Red")+
#   ggplot2::labs(y = "-log10(Adjusted p-value)") +
#   ggplot2::ggtitle(label = "COPD status") +
#   ggplot2::theme(plot.title = ggplot2::element_text(
#     hjust = 0.5,
#     size = 18
#   )) 
```

```{r, message = F, warning = F}
df <- data.frame(x = annotNasal$FEV_FVC, y = annotNasal$TIN)
lm_eqn <- function(df){
  # browser()
  m <- lm(y ~ x, df)
  a <- coef(m)[1]
  a <- ifelse(sign(a) >= 0, 
              paste0(" + ", format(a, digits = 4)), 
              paste0(" - ", format(-a, digits = 4))  )
  eq1 <- substitute( paste( italic(y) == b, italic(x), a ), 
                     list(a = a, 
                          b = format(coef(m)[2], digits = 4)))
  eq2 <- substitute( paste( italic(R)^2 == r2 ), 
                     list(r2 = format(summary(m)$r.squared, digits = 3)))
  c( as.character(as.expression(eq1)), as.character(as.expression(eq2)))
}

labels <- lm_eqn(df)


ggplot(annotNasal, aes(x = FEV_FVC, y = TIN)) +
  geom_point(size = 0.75) +
  ggplot2::theme_bw() +
  ggplot2::theme(
    panel.grid.major = ggplot2::element_blank(),
    panel.grid.minor = ggplot2::element_blank(),
    axis.text = ggplot2::element_text(size = 14),
    axis.title = ggplot2::element_text(size = 14)
  ) +
  ggplot2::theme(legend.title = ggplot2::element_text(size = 15), legend.text = ggplot2::element_text(size = 13)) +
  ggplot2::guides(
    colour =
      ggplot2::guide_legend(override.aes = list(size = 2))
  ) + geom_smooth(method=lm)+
  geom_text(x = 75, y = 90, label = labels[1], parse = TRUE,  check_overlap = TRUE )

# 
#   geom_point(data = resSig, aes(x = log2FoldChange, y = nLogPVal), color = "Red")+
#   ggplot2::labs(y = "-log10(Adjusted p-value)") +
#   ggplot2::ggtitle(label = "COPD status") +
#   ggplot2::theme(plot.title = ggplot2::element_text(
#     hjust = 0.5,
#     size = 18
#   )) 
```
### Tables

#### Differentially expressed in COPD patients

```{r}
resSigDown <- resSig[resSig$log2FoldChange < -0.5, ]
resSigDown <- resSigDown[order(resSigDown$log2FoldChange, decreasing = F),]
resSigDown <- resSigDown[,c(2,5,6)]
colnames(resSigDown) <- c("Log2FC", "P-value", "Adj. P-value")
resSigDown %>%
  knitr::kable(
    format = "html", align = rep("c", ncol(resSig) + 1),
    row.names = TRUE
  ) %>%
  kableExtra::kable_styling() %>%
  kableExtra::scroll_box(height = "300px")
```

#### Differentially expressed in non-COPD patients

```{r}
resSigUp <- resSig[resSig$log2FoldChange > 0.5, ]
resSigUp <- resSigUp[order(resSigUp$log2FoldChange, decreasing = T),]
resSigUp <- resSigUp[,c(2,5,6)]
colnames(resSigUp) <- c("Log2FC", "P-value", "Adj. P-value")
resSigUp %>%
  knitr::kable(
    format = "html", align = rep("c", ncol(resSig) + 1),
    row.names = TRUE
  ) %>%
  kableExtra::kable_styling() %>%
  kableExtra::scroll_box(height = "300px")
```

### Checking for overlap between COPD signature

Differentially expressed genes were checked for overlap with the 98 genes from the COPD signature from [Steiling et al, 2013](https://pubmed.ncbi.nlm.nih.gov/23471465/)

```{r}
#Preprocessing. Run ahead of time and comment out when knitting Rmd
names(steilingGenes) <- "Names"
steilingSignature <- steilingGenes$Names
steilingUp <- head(steilingSignature,54)

#create mart object, this is for homo sapiens

mart <- useMart(biomart = "ensembl", dataset = "hsapiens_gene_ensembl")

upBM <- getBM(filters= "hgnc_symbol", attributes= c("ensembl_gene_id","hgnc_symbol"),values=steilingUp,mart= mart)

upBM <- upBM[upBM$ensembl_gene_id %in% rownames(assay(seNasal)),]
# write.table(upBM$ensembl_gene_id, "20201102_SteilingUp_Genelist.grp", sep = "\t", quote = F, col.names = F, row.names = F)
steilingDown <- tail(steilingSignature,44)

downBM <- getBM(filters= "hgnc_symbol", attributes= c("ensembl_gene_id","hgnc_symbol"),values=steilingDown,mart= mart)
downBM <- downBM[-32,]
# write.table(downBM$ensembl_gene_id, "20201102_SteilingDown_Genelist.grp", sep = "\t", quote = F, col.names = F, row.names = F)

#Send to GSEA 11/3/2020


#Check for overlap:
upoverlap <- sum(downBM$hgnc_symbol %in% rownames(resSigUp))
upoverlapgenes <- downBM$hgnc_symbol[downBM$hgnc_symbol %in% rownames(resSigUp)]
downoverlap <- sum(upBM$hgnc_symbol %in% rownames(resSigDown))
downoverlapgenes <- upBM$hgnc_symbol[upBM$hgnc_symbol %in% rownames(resSigDown)]
```

Overall, of the 54 genes associated with increase of COPD status in the Steiling signature, `r downoverlap` were differentially expressed in patients considered to be of COPD status. These are: `r downoverlapgenes`. 

Of the 44 genes associated with decrease of COPD status in the Steiling signature, `r upoverlap` were differentially expressed in patients considered to be of COPD status. These are: `r upoverlapgenes`.

### GSEA, comparison with COPD signature {.tabset}

Gene set enrichment analysis was conducted using genes associated with COPD status from [Steiling et al, 2013](https://pubmed.ncbi.nlm.nih.gov/23471465/). The preranked version of GSEA was performed on normalized counts generated from DESeq2. The rank was generated in ascending order of log2 fold change values outputted from DESeq2.

Model used: ~Smoking status + Age + TIN + COPD status

#### Upregulated Genes in COPD

54 Genes associated with increase in COPD status were used for GSEA.

```{r}
GSEA <- c(0.57, 1.85, 0.006, 0.006, 0.004)
GSEA <- as.data.frame(as.matrix(GSEA))
rownames(GSEA) <- c("Enrichment Score",
                    "Normalized Enrichment Score",
                    "Nominal p-value",
                    "FDR q-value",
                    "FWER q-value")
colnames(GSEA) <- c("Upregulated in COPD patients")

GSEA %>%
  knitr::kable(
    format = "html", align = rep("c", ncol(GSEA) + 1),
    row.names = TRUE
  ) %>%
  kableExtra::kable_styling() %>%
  kableExtra::scroll_box(height = "200px")

gsea_details3 <- read.csv("/restricted/projectnb/camplab/home/ykoga07/DECAMP/Novartis/Analysis/1stPass/GSEA_Increase_in_COPD_PreRank_Nasal.csv", row.names = 1)
colnames(gsea_details3) <- gsub("\\.", "_", colnames(gsea_details3)) 

gsea_details3 <- merge(upBM, gsea_details3, by.x = "ensembl_gene_id", by.y = "ENSEMBL_GENEID")
gsea_details3 <- gsea_details3[order(gsea_details3$RANK_IN_GENE_LIST),]

gsea_details3 %>%
  knitr::kable(
    format = "html", align = rep("c", ncol(gsea_details3) + 1),
    row.names = FALSE
  ) %>%
  kableExtra::kable_styling() %>%
  kableExtra::scroll_box(height = "300px")
```

<br> 

![](/restricted/projectnb/camplab/home/ykoga07/DECAMP/Novartis/Analysis/1stPass/enplot_20201104_GSEA_Increase_in_COPD_PreRank_Nasal.png)

#### Downregulated Genes in COPD

44 Genes associated with decrease in COPD status were used for GSEA.

```{r}
GSEA <- c(-0.43,-1.49,0.02,0.02, 0.007)
GSEA <- as.data.frame(as.matrix(GSEA))
rownames(GSEA) <- c("Enrichment Score",
                    "Normalized Enrichment Score",
                    "Nominal p-value",
                    "FDR q-value",
                    "FWER q-value")
colnames(GSEA) <- c("Downregulated in COPD patients")

GSEA %>%
  knitr::kable(
    format = "html", align = rep("c", ncol(GSEA) + 1),
    row.names = TRUE
  ) %>%
  kableExtra::kable_styling() %>%
  kableExtra::scroll_box(height = "200px")

gsea_details4 <- read.csv("/restricted/projectnb/camplab/home/ykoga07/DECAMP/Novartis/Analysis/1stPass/GSEA_Decrease_in_COPD_PreRank_Nasal.csv", row.names = 1)
colnames(gsea_details4) <- gsub("\\.", "_", colnames(gsea_details4)) 

gsea_details4 <- merge(downBM, gsea_details4, by.x = "ensembl_gene_id", by.y = "ENSEMBL_GENEID")
gsea_details4 <- gsea_details4[order(gsea_details4$RANK_IN_GENE_LIST),]

gsea_details4 %>%
  knitr::kable(
    format = "html", align = rep("c", ncol(gsea_details4) + 1),
    row.names = FALSE
  ) %>%
  kableExtra::kable_styling() %>%
  kableExtra::scroll_box(height = "300px")
```

<br> 

![](/restricted/projectnb/camplab/home/ykoga07/DECAMP/Novartis/Analysis/1stPass/enplot_20201104_GSEA_Decrease_in_COPD_PreRank_Nasal.png)

### EnrichR, upregulated genes {.tabset}

```{r, message = F, warning = F, echo = F}
dbs <- listEnrichrDbs()
websiteLive <- TRUE

if (is.null(dbs)){
  websiteLive <- FALSE
}

dbs <- c("GO_Molecular_Function_2015", "GO_Cellular_Component_2015", "GO_Biological_Process_2015")
if (websiteLive){
  enriched <- suppressMessages(enrichr(rownames(resSigUp), dbs))
}

go_biological <- enriched[["GO_Biological_Process_2015"]]
go_molecular <- enriched[["GO_Molecular_Function_2015"]]
go_cellular <- enriched[["GO_Cellular_Component_2015"]]
```

#### GO_Biological_Process_2015

```{r}
go_biological %>%
  knitr::kable(
    format = "html", align = rep("c", ncol(go_biological) + 1),
    row.names = TRUE
  ) %>%
  kableExtra::kable_styling() %>%
  kableExtra::scroll_box(height = "300px")
```

#### GO_Cellular_Component_2015

```{r}
go_cellular %>%
  knitr::kable(
    format = "html", align = rep("c", ncol(go_cellular) + 1),
    row.names = TRUE
  ) %>%
  kableExtra::kable_styling() %>%
  kableExtra::scroll_box(height = "300px")
```

#### GO_Molecular_Function_2015

```{r}
go_molecular %>%
  knitr::kable(
    format = "html", align = rep("c", ncol(go_molecular) + 1),
    row.names = TRUE
  ) %>%
  kableExtra::kable_styling() %>%
  kableExtra::scroll_box(height = "300px")

```

### EnrichR, downregulated genes {.tabset}

```{r, message = F, warning = F, echo = F}
dbs <- listEnrichrDbs()
websiteLive <- TRUE

if (is.null(dbs)){
  websiteLive <- FALSE
}

dbs <- c("GO_Molecular_Function_2015", "GO_Cellular_Component_2015", "GO_Biological_Process_2015")
if (websiteLive){
  enriched <- suppressMessages(enrichr(rownames(resSigDown), dbs))
}

go_biological <- enriched[["GO_Biological_Process_2015"]]
go_molecular <- enriched[["GO_Molecular_Function_2015"]]
go_cellular <- enriched[["GO_Cellular_Component_2015"]]
```

#### GO_Biological_Process_2015

```{r}
go_biological %>%
  knitr::kable(
    format = "html", align = rep("c", ncol(go_biological) + 1),
    row.names = TRUE
  ) %>%
  kableExtra::kable_styling() %>%
  kableExtra::scroll_box(height = "300px")
```

#### GO_Cellular_Component_2015

```{r}
go_cellular %>%
  knitr::kable(
    format = "html", align = rep("c", ncol(go_cellular) + 1),
    row.names = TRUE
  ) %>%
  kableExtra::kable_styling() %>%
  kableExtra::scroll_box(height = "300px")
```

#### GO_Molecular_Function_2015

```{r}
go_molecular %>%
  knitr::kable(
    format = "html", align = rep("c", ncol(go_molecular) + 1),
    row.names = TRUE
  ) %>%
  kableExtra::kable_styling() %>%
  kableExtra::scroll_box(height = "300px")

```

# Reproducibility

<details><summary>For reproducibility:</summary>

```{r, warning = F, message = F}
## datetime

Sys.time()
```

```{r, warning = F, message = F}
## session info

sessionInfo()
```
</details>
